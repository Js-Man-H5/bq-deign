"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),N=require("three"),S=require("../../utils/tool.js");function q(u){const d=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(u){for(const o in u)if(o!=="default"){const p=Object.getOwnPropertyDescriptor(u,o);Object.defineProperty(d,o,p.get?p:{enumerable:!0,get:()=>u[o]})}}return d.default=u,Object.freeze(d)}const s=q(N),G={class:"three-pie-container"},V={class:"three-pie-main"},W={class:"pie-value"},j={class:"pie-label"},R=65,H=e.defineComponent({name:"BqPie",__name:"Pie",props:{data:{default:()=>[{value:.6637,label:"TM"},{value:.2171,label:"DOUYIN"},{value:.0764,label:"JD"},{value:.0237,label:"VIP"},{value:.0191,label:"Others"}]},colorList:{default:()=>["#93DBFF","#4B84F0","#FFD982","#00D7FF","#49C384"]},innerRadius:{default:60},outRadius:{default:84},depth:{default:15},centerTooltip:{type:Boolean,default:!0}},setup(u){let d=0;const o=u;let p=["#93DBFF","#4B84F0","#FFD982","#00D7FF","#49C384"];const i=e.ref();let E=null,m=null;const M=new s.Scene;let g=null;const T=()=>{if(i.value){const t=i.value?.clientWidth/i.value.clientHeight,a=Math.min(i.value.clientWidth,i.value.clientHeight)/2;g=new s.OrthographicCamera(-a*t,a*t,a,-a,1,1e3),g.position.set(0,0,686),g.lookAt(M.position),E&&M.remove(E),E=k(),B(),M.add(E),m=new s.WebGLRenderer({canvas:i.value,antialias:!0,alpha:!0}),m.setSize(i.value.clientWidth,i.value.clientHeight),m.setClearColor(16777215,0),m.setPixelRatio(2),m.render(M,g)}},k=()=>{const t=new s.Group;return h.value.forEach((n,a)=>{const l=p[a%p.length],r=o.colorList[a%o.colorList.length],b=P(n.startAngle,n.endAngle,l,"sector");t.add(b);const v=P(n.startAngle,n.endAngle,r,"bottomSector");v.renderOrder=999,t.add(v);const f=x(n.startAngle,n.endAngle);t.add(f)}),t},w=e.computed(()=>({curveSegments:40,depth:o.depth,bevelEnabled:!1,bevelSegments:9,steps:2,bevelSize:0,bevelThickness:0})),D=(t,n,a,l)=>{const r=new s.Shape;return r.moveTo(o.outRadius,0),r.absarc(0,0,a,t,n,!0),r.absarc(0,0,l,n,t,!1),r},P=(t,n,a,l)=>{const r=D(t,n,o.innerRadius,o.outRadius),b=S.deepClone(w.value);let v=.9;l==="bottomSector"&&(v=.6,b.depth=1);const f=new s.ExtrudeGeometry(r,b),L=new s.MeshBasicMaterial({color:a,opacity:v,transparent:!0,depthTest:!0}),y=new s.Mesh(f,L);return y.position.set(0,0,0),y.renderOrder=2,y.rotateX(-(R/180)*Math.PI),y},x=(t,n)=>{const a=D(t,n,o.innerRadius+1,o.outRadius-1),l=S.deepClone(w.value),r=new s.ExtrudeGeometry(a,l),b=new s.EdgesGeometry(r,10),v=new s.MeshStandardMaterial({fog:!1,color:16777215,emissive:16777215,transparent:!0,opacity:.5,roughness:0}),f=new s.LineSegments(b,v);return f.rotateX(-(R/180)*Math.PI),f.renderOrder=4,f},O=function(){let t=!1;return o.data.length!==o.colorList.length&&(console.warn("颜色和数据长度不匹配"),t=!0),t}(),I=.3*Math.PI*2,c=e.ref(0),h=e.ref([]);let A=0;e.watchEffect(()=>{if(O)return!1;if(p=o.colorList||p,h.value=S.deepClone(o.data)||[],h.value.length===0)return;A=h.value.reduce((n,a)=>typeof a.value=="number"?n+a.value:n,0);let t=I;h.value.forEach(n=>{n.startAngle=t,n.endAngle=n.startAngle-n.value/A*Math.PI*2,t=n.endAngle}),e.nextTick(()=>{T(),_()})});const C=e.ref(0);let F=0;const _=()=>{const t=h.value.length;if((c.value%1>.99||c.value%1<.01)&&F<1){C.value=Math.round(c.value)>=t?0:Math.round(c.value),F+=.01,S.isWindow&&(d=requestAnimationFrame(_));return}F=0,c.value+=.01,c.value>t&&(c.value=0),B(),g&&m?.render(M,g),S.isWindow&&(d=requestAnimationFrame(_))},B=()=>{const t=h.value.length,n=(c.value+1)*10%(t*10)/10;E?.children.forEach((a,l)=>{if(Math.floor(c.value)===Math.ceil((l-2)/3)){const r=1-c.value%1;a.scale.set(1,1,1+r)}if(Math.floor(n)===Math.ceil((l-2)/3)){const r=c.value%1;a.scale.set(1,1,1+r)}})};return e.onUnmounted(()=>{cancelAnimationFrame(d)}),(t,n)=>(e.openBlock(),e.createElementBlock("div",G,[e.createElementVNode("div",V,[e.createElementVNode("canvas",{ref_key:"pieRef",ref:i,class:"pie-canvas"},null,512),o.centerTooltip?(e.openBlock(!0),e.createElementBlock(e.Fragment,{key:0},e.renderList(o.data,(a,l)=>(e.openBlock(),e.createElementBlock("div",{key:a.value,class:"pie-info",style:e.normalizeStyle({opacity:e.unref(C)===l?1:0})},[e.createElementVNode("div",W,e.toDisplayString(e.unref(S.toPercent)(a.value)),1),e.createElementVNode("div",j,e.toDisplayString(a.label),1)],4))),128)):e.createCommentVNode("",!0)]),e.renderSlot(t.$slots,"footer",{},void 0,!0)]))}});exports.default=H;
