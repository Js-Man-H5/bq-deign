"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const t=require("vue"),N=require("three"),E=require("../../utils/tool.js");function q(d){const p=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(d){for(const a in d)if(a!=="default"){const h=Object.getOwnPropertyDescriptor(d,a);Object.defineProperty(p,a,h.get?h:{enumerable:!0,get:()=>d[a]})}}return p.default=d,Object.freeze(p)}const s=q(N),G={class:"three-pie-container"},V={class:"three-pie-main"},W={class:"pie-value"},j={class:"pie-label"},R=65,H=t.defineComponent({name:"BqPie",__name:"Pie",props:{data:{default:()=>[{value:.6637,label:"TM"},{value:.2171,label:"DOUYIN"},{value:.0764,label:"JD"},{value:.0237,label:"VIP"},{value:.0191,label:"Others"}]},colorList:{default:()=>["#93DBFF","#4B84F0","#FFD982","#00D7FF","#49C384"]},innerRadius:{default:60},outRadius:{default:84},depth:{default:15},centerTooltip:{type:Boolean,default:!0}},setup(d){let p=0;const a=d;let h=["#93DBFF","#4B84F0","#FFD982","#00D7FF","#49C384"];const i=t.ref();let v=null,u=null;const M=new s.Scene;let b=null;const T=()=>{var n;if(i.value){const e=((n=i.value)==null?void 0:n.clientWidth)/i.value.clientHeight,r=Math.min(i.value.clientWidth,i.value.clientHeight)/2;b=new s.OrthographicCamera(-r*e,r*e,r,-r,1,1e3),b.position.set(0,0,686),b.lookAt(M.position),v&&M.remove(v),v=k(),B(),M.add(v),u=new s.WebGLRenderer({canvas:i.value,antialias:!0,alpha:!0}),u.setSize(i.value.clientWidth,i.value.clientHeight),u.setClearColor(16777215,0),u.setPixelRatio(2),u.render(M,b)}},k=()=>{const n=new s.Group;return f.value.forEach((e,o)=>{const r=h[o%h.length],l=a.colorList[o%a.colorList.length],S=P(e.startAngle,e.endAngle,r,"sector");n.add(S);const m=P(e.startAngle,e.endAngle,l,"bottomSector");m.renderOrder=999,n.add(m);const g=x(e.startAngle,e.endAngle);n.add(g)}),n},w=t.computed(()=>({curveSegments:40,depth:a.depth,bevelEnabled:!1,bevelSegments:9,steps:2,bevelSize:0,bevelThickness:0})),D=(n,e,o,r)=>{const l=new s.Shape;return l.moveTo(a.outRadius,0),l.absarc(0,0,o,n,e,!0),l.absarc(0,0,r,e,n,!1),l},P=(n,e,o,r)=>{const l=D(n,e,a.innerRadius,a.outRadius),S=E.deepClone(w.value);let m=.9;r==="bottomSector"&&(m=.6,S.depth=1);const g=new s.ExtrudeGeometry(l,S),L=new s.MeshBasicMaterial({color:o,opacity:m,transparent:!0,depthTest:!0}),y=new s.Mesh(g,L);return y.position.set(0,0,0),y.renderOrder=2,y.rotateX(-(R/180)*Math.PI),y},x=(n,e)=>{const o=D(n,e,a.innerRadius+1,a.outRadius-1),r=E.deepClone(w.value),l=new s.ExtrudeGeometry(o,r),S=new s.EdgesGeometry(l,10),m=new s.MeshStandardMaterial({fog:!1,color:16777215,emissive:16777215,transparent:!0,opacity:.5,roughness:0}),g=new s.LineSegments(S,m);return g.rotateX(-(R/180)*Math.PI),g.renderOrder=4,g},O=function(){let n=!1;return a.data.length!==a.colorList.length&&(console.warn("颜色和数据长度不匹配"),n=!0),n}(),I=.3*Math.PI*2,c=t.ref(0),f=t.ref([]);let A=0;t.watchEffect(()=>{if(O)return!1;if(h=a.colorList||h,f.value=E.deepClone(a.data)||[],f.value.length===0)return;A=f.value.reduce((e,o)=>typeof o.value=="number"?e+o.value:e,0);let n=I;f.value.forEach(e=>{e.startAngle=n,e.endAngle=e.startAngle-e.value/A*Math.PI*2,n=e.endAngle}),t.nextTick(()=>{T(),_()})});const C=t.ref(0);let F=0;const _=()=>{const n=f.value.length;if((c.value%1>.99||c.value%1<.01)&&F<1){C.value=Math.round(c.value)>=n?0:Math.round(c.value),F+=.01,E.isWindow&&(p=requestAnimationFrame(_));return}F=0,c.value+=.01,c.value>n&&(c.value=0),B(),b&&(u==null||u.render(M,b)),E.isWindow&&(p=requestAnimationFrame(_))},B=()=>{const n=f.value.length,e=(c.value+1)*10%(n*10)/10;v==null||v.children.forEach((o,r)=>{if(Math.floor(c.value)===Math.ceil((r-2)/3)){const l=1-c.value%1;o.scale.set(1,1,1+l)}if(Math.floor(e)===Math.ceil((r-2)/3)){const l=c.value%1;o.scale.set(1,1,1+l)}})};return t.onUnmounted(()=>{cancelAnimationFrame(p)}),(n,e)=>(t.openBlock(),t.createElementBlock("div",G,[t.createElementVNode("div",V,[t.createElementVNode("canvas",{ref_key:"pieRef",ref:i,class:"pie-canvas"},null,512),a.centerTooltip?(t.openBlock(!0),t.createElementBlock(t.Fragment,{key:0},t.renderList(a.data,(o,r)=>(t.openBlock(),t.createElementBlock("div",{key:o.value,class:"pie-info",style:t.normalizeStyle({opacity:t.unref(C)===r?1:0})},[t.createElementVNode("div",W,t.toDisplayString(t.unref(E.toPercent)(o.value)),1),t.createElementVNode("div",j,t.toDisplayString(o.label),1)],4))),128)):t.createCommentVNode("",!0)]),t.renderSlot(n.$slots,"footer",{},void 0,!0)]))}});exports.default=H;
